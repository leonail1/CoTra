
set(COROMEM_VER 1.0.0)
set(COROMEM_NAME "coromem_${COROMEM_VER}")
message("-- Build ${COROMEM_NAME}")

add_library(coromem)
set_target_properties(coromem PROPERTIES EXPORT_NAME shmem)
add_dependencies(lib coromem)

set(sources
        src/barrier.cpp
        src/barrier_mcs.cpp
        src/context.cpp
        src/mem.cpp
        src/numa_mem.cpp
        src/backend.cpp
        src/ptr_lock.cpp
        src/simple_lock.cpp
        src/termination.cpp
        src/threadpool.cpp
        src/utils.cpp
        src/hwtopo.cpp
        src/hugepage.cpp
        src/share_mem.cpp
)
include(CheckSchedSetAffinity)

target_sources(coromem PRIVATE ${sources})

target_include_directories(coromem PUBLIC
  $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/include>
  $<BUILD_INTERFACE:${CMAKE_CURRENT_BINARY_DIR}/include>
)


if (TARGET Boost::Boost)
  # Autogenerated conan module doesn't provide header-only target. Extract one manually.
  get_target_property(include_dirs Boost::Boost INTERFACE_INCLUDE_DIRECTORIES)
  target_include_directories(coromem PUBLIC ${include_dirs})
else()
  # Standard CMake Boost module
  target_link_libraries(coromem PUBLIC Boost::boost)
endif()

if (SCHED_SETAFFINITY_FOUND)
  target_compile_definitions(coromem PRIVATE GALOIS_USE_SCHED_SETAFFINITY)
  target_link_libraries(coromem PRIVATE ${SCHED_SETAFFINITY_LIBRARIES})
endif()

target_link_libraries(coromem PRIVATE Threads::Threads)

if (CMAKE_HAVE_PTHREAD_H)
  target_compile_definitions(coromem PRIVATE GALOIS_HAVE_PTHREAD)
endif()

find_package(NUMA)
if (NUMA_FOUND)
  target_compile_definitions(coromem PRIVATE GALOIS_USE_NUMA)
  target_link_libraries(coromem PRIVATE ${NUMA_LIBRARY})
else()
  message(WARNING "No NUMA Support. Likely poor performance for multi-socket systems.")
endif()

find_package(fmt)
target_link_libraries(coromem PRIVATE fmt::fmt)
